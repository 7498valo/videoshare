<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEXUS â€” Voice & Screen</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080c12;
    --surface: #0d1520;
    --surface2: #121e2e;
    --border: rgba(0,200,255,0.12);
    --accent: #00c8ff;
    --accent2: #00ff9d;
    --danger: #ff3b5c;
    --warn: #ffb800;
    --text: #e8f4ff;
    --muted: #4a6a8a;
    --glow: 0 0 20px rgba(0,200,255,0.25);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Syne', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 60% 40% at 20% 20%, rgba(0,200,255,0.06) 0%, transparent 60%),
      radial-gradient(ellipse 50% 50% at 80% 80%, rgba(0,255,157,0.04) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  /* â”€â”€â”€ GRID NOISE â”€â”€â”€ */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background-image: linear-gradient(rgba(0,200,255,0.03) 1px, transparent 1px),
                      linear-gradient(90deg, rgba(0,200,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .page { position: relative; z-index: 1; }

  /* â”€â”€â”€ AUTH â”€â”€â”€ */
  #auth-screen {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 2rem;
  }

  .auth-card {
    width: 100%;
    max-width: 420px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 3rem 2.5rem;
    box-shadow: 0 0 60px rgba(0,200,255,0.08), 0 40px 80px rgba(0,0,0,0.5);
    animation: fadeUp 0.6s ease;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(30px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 2.5rem;
  }

  .logo-icon {
    width: 42px; height: 42px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
  }

  .logo-text {
    font-size: 1.6rem;
    font-weight: 800;
    letter-spacing: 0.12em;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .auth-title {
    font-size: 1.4rem;
    font-weight: 700;
    margin-bottom: 0.4rem;
  }

  .auth-sub {
    color: var(--muted);
    font-size: 0.85rem;
    margin-bottom: 2rem;
  }

  .tab-row {
    display: flex;
    background: var(--bg);
    border-radius: 10px;
    padding: 4px;
    margin-bottom: 2rem;
  }

  .tab-btn {
    flex: 1;
    padding: 0.5rem;
    border: none;
    background: none;
    color: var(--muted);
    font-family: 'Syne', sans-serif;
    font-weight: 600;
    font-size: 0.85rem;
    border-radius: 7px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .tab-btn.active {
    background: var(--surface2);
    color: var(--accent);
  }

  .field {
    margin-bottom: 1.2rem;
  }

  label {
    display: block;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 0.5rem;
  }

  input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.75rem 1rem;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,200,255,0.1);
  }

  .btn {
    width: 100%;
    padding: 0.85rem;
    border: none;
    border-radius: 12px;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.95rem;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent), #0099dd);
    color: #000;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,200,255,0.35);
  }

  .btn-primary:active { transform: translateY(0); }

  .msg { 
    margin-top: 1rem; 
    font-size: 0.82rem; 
    text-align: center;
    padding: 0.6rem;
    border-radius: 8px;
  }
  .msg.error { background: rgba(255,59,92,0.1); color: var(--danger); }
  .msg.success { background: rgba(0,255,157,0.1); color: var(--accent2); }

  /* â”€â”€â”€ APP â”€â”€â”€ */
  #app-screen { display: none; min-height: 100vh; }

  .app-layout {
    display: grid;
    grid-template-columns: 260px 1fr;
    grid-template-rows: 60px 1fr;
    min-height: 100vh;
  }

  /* Header */
  .topbar {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1.5rem;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }

  .topbar-logo { display: flex; align-items: center; gap: 8px; }
  .topbar-logo .logo-text { font-size: 1.1rem; }

  .topbar-user {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .avatar {
    width: 34px; height: 34px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-weight: 800;
    font-size: 0.8rem;
    color: #000;
  }

  .user-name { font-weight: 600; font-size: 0.9rem; }

  .btn-logout {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0.3rem 0.8rem;
    border-radius: 8px;
    cursor: pointer;
    font-family: 'Syne', sans-serif;
    font-size: 0.8rem;
    transition: all 0.2s;
  }
  .btn-logout:hover { border-color: var(--danger); color: var(--danger); }

  /* Sidebar */
  .sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 1.5rem 1rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .sidebar-section-title {
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    padding: 0 0.5rem;
    margin-bottom: 0.5rem;
  }

  .my-id-box {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.75rem 1rem;
  }

  .my-id-label { font-size: 0.65rem; font-weight: 700; letter-spacing: 0.1em; color: var(--muted); text-transform: uppercase; margin-bottom: 0.4rem; }

  .my-id-val {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.78rem;
    color: var(--accent2);
    word-break: break-all;
    cursor: pointer;
  }

  .my-id-val:hover { opacity: 0.7; }

  .copy-hint { font-size: 0.65rem; color: var(--muted); margin-top: 4px; }

  .connect-box { display: flex; flex-direction: column; gap: 0.5rem; }

  .connect-input {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.6rem 0.8rem;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem;
    outline: none;
    width: 100%;
    transition: border-color 0.2s;
  }
  .connect-input:focus { border-color: var(--accent); }

  .btn-connect {
    background: linear-gradient(135deg, var(--accent), #0099dd);
    color: #000;
    border: none;
    border-radius: 10px;
    padding: 0.6rem;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.82rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-connect:hover { box-shadow: 0 4px 15px rgba(0,200,255,0.3); }

  /* Peers list */
  .peers-list { display: flex; flex-direction: column; gap: 0.4rem; flex: 1; }

  .peer-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 0.6rem 0.75rem;
    border-radius: 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    font-size: 0.82rem;
    transition: all 0.2s;
  }

  .peer-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--accent2);
    box-shadow: 0 0 6px var(--accent2);
    flex-shrink: 0;
  }

  .peer-name { flex: 1; font-weight: 600; font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  .btn-disconnect {
    background: none;
    border: none;
    color: var(--danger);
    cursor: pointer;
    font-size: 0.8rem;
    opacity: 0.6;
    transition: opacity 0.2s;
    padding: 2px 4px;
  }
  .btn-disconnect:hover { opacity: 1; }

  .empty-peers {
    color: var(--muted);
    font-size: 0.78rem;
    text-align: center;
    padding: 1rem;
    border: 1px dashed var(--border);
    border-radius: 10px;
  }

  /* Main area */
  .main-area {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1.5rem;
    padding: 1.5rem;
    overflow: hidden;
  }

  .main-left {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    overflow-y: auto;
  }

  /* Controls */
  .controls-bar {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .ctrl-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0.7rem 1.2rem;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .ctrl-btn:hover { border-color: var(--accent); box-shadow: var(--glow); }

  .ctrl-btn.active {
    background: linear-gradient(135deg, var(--accent), #0099dd);
    color: #000;
    border-color: transparent;
    box-shadow: 0 4px 20px rgba(0,200,255,0.3);
  }

  .ctrl-btn.danger { border-color: rgba(255,59,92,0.3); }
  .ctrl-btn.danger.active { background: linear-gradient(135deg, var(--danger), #cc0033); color: #fff; box-shadow: 0 4px 20px rgba(255,59,92,0.3); }

  .ctrl-icon { font-size: 1.1rem; }

  /* Volume meter */
  .volume-meter {
    display: flex;
    gap: 3px;
    align-items: flex-end;
    height: 20px;
  }

  .vol-bar {
    width: 4px;
    background: var(--accent2);
    border-radius: 2px;
    transition: height 0.08s;
    min-height: 3px;
  }

  /* Screen share area */
  .screen-area {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    position: relative;
    min-height: 420px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .screen-placeholder {
    text-align: center;
    color: var(--muted);
  }

  .screen-placeholder .ph-icon { font-size: 3rem; margin-bottom: 1rem; }
  .screen-placeholder h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.4rem; }
  .screen-placeholder p { font-size: 0.82rem; }

  #screen-video, #remote-screen-video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: none;
  }

  .screen-label {
    position: absolute;
    top: 1rem;
    left: 1rem;
    background: rgba(0,0,0,0.7);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.3rem 0.7rem;
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    color: var(--accent);
    text-transform: uppercase;
    display: none;
  }

  /* Remote audio */
  audio { display: none; }

  /* Messaging Panel */
  .messaging-panel {
    display: flex;
    flex-direction: column;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    gap: 0;
  }

  .msg-header {
    padding: 1rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 700;
    font-size: 0.9rem;
  }

  #msg-peer-select {
    margin-left: auto;
    padding: 0.4rem 0.6rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'Syne', sans-serif;
    font-size: 0.8rem;
    cursor: pointer;
  }
  #msg-peer-select:focus { border-color: var(--accent); outline: none; }

  .messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .message {
    display: flex;
    gap: 0.5rem;
    animation: fadeUp 0.3s ease;
  }

  .message.self {
    justify-content: flex-end;
  }

  .message-content {
    max-width: 80%;
    padding: 0.6rem 0.9rem;
    border-radius: 10px;
    font-size: 0.85rem;
    line-height: 1.4;
    word-wrap: break-word;
  }

  .message.other .message-content {
    background: var(--surface2);
    color: var(--text);
  }

  .message.self .message-content {
    background: linear-gradient(135deg, var(--accent), #0099dd);
    color: #000;
    font-weight: 600;
  }

  .message-meta {
    font-size: 0.7rem;
    color: var(--muted);
    padding: 0 0.5rem;
  }

  .message-file {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.8rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.8rem;
    cursor: pointer;
  }

  .message-file:hover {
    border-color: var(--accent);
    box-shadow: var(--glow);
  }

  .message-file-icon { font-size: 1.2rem; }
  .message-file-info { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; }
  .message-file-name { font-weight: 600; color: var(--accent); }
  .message-file-size { color: var(--muted); }

  .msg-input-area {
    display: flex;
    gap: 0.5rem;
    padding: 1rem;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }

  .msg-text-input {
    flex: 1;
    padding: 0.6rem 0.9rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'Syne', sans-serif;
    font-size: 0.85rem;
    outline: none;
    transition: border-color 0.2s;
  }

  .msg-text-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,200,255,0.1);
  }

  .msg-btn-send,
  .msg-btn-file {
    padding: 0.6rem 1rem;
    border: none;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), #0099dd);
    color: #000;
    font-family: 'Syne', sans-serif;
    font-size: 0.8rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
  }

  .msg-btn-send:hover,
  .msg-btn-file:hover {
    box-shadow: 0 4px 12px rgba(0,200,255,0.3);
  }

  .msg-btn-send:active,
  .msg-btn-file:active {
    transform: translateY(1px);
  }

  .upload-progress {
    padding: 0.8rem 1rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 0.8rem;
    align-items: center;
    font-size: 0.8rem;
    background: rgba(0,200,255,0.05);
  }

  .progress-bar {
    flex: 1;
    height: 6px;
    background: var(--bg);
    border-radius: 3px;
    overflow: hidden;
  }

  #progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #0099dd);
    width: 0%;
    transition: width 0.2s;
  }

  #progress-text {
    min-width: 30px;
    color: var(--accent);
    font-weight: 600;
  }

  /* Status bar */
  .status-bar {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    font-size: 0.78rem;
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
  }

  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--muted);
  }
  .status-dot.connected { background: var(--accent2); box-shadow: 0 0 6px var(--accent2); }
  .status-dot.connecting { background: var(--warn); animation: pulse 1s infinite; }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .notification {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 0.8rem 1.2rem;
    font-size: 0.85rem;
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    transform: translateX(200%);
    transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
    z-index: 100;
    max-width: 300px;
  }
  .notification.show { transform: translateX(0); }
  .notification.success { border-color: rgba(0,255,157,0.3); }
  .notification.error { border-color: rgba(255,59,92,0.3); }

  /* Mute indicator */
  .mute-banner {
    display: none;
    align-items: center;
    gap: 8px;
    background: rgba(255,59,92,0.1);
    border: 1px solid rgba(255,59,92,0.2);
    border-radius: 10px;
    padding: 0.5rem 1rem;
    font-size: 0.82rem;
    color: var(--danger);
    font-weight: 600;
  }
  .mute-banner.visible { display: flex; }

  .peers-section { flex: 1; overflow-y: auto; }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  @media (max-width: 700px) {
    .app-layout { grid-template-columns: 1fr; grid-template-rows: 60px auto 1fr; }
    .sidebar { border-right: none; border-bottom: 1px solid var(--border); }
  }
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth-screen" class="page">
  <div class="auth-card">
    <div class="logo">
      <div class="logo-icon">ğŸ“¡</div>
      <span class="logo-text">NEXUS</span>
    </div>
    <div class="auth-title">ã‚ˆã†ã“ã</div>
    <div class="auth-sub">Voice chat & screen sharing platform</div>

    <div id="register-form">
      <div class="field"><label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ </label><input type="text" id="reg-user" placeholder="your username" autocomplete="username"></div>
      <button class="btn btn-primary" onclick="register()">é–‹å§‹ â†’</button>
    </div>

    <div id="auth-msg"></div>
  </div>
</div>

<!-- APP -->
<div id="app-screen" class="page">
  <div class="app-layout">

    <!-- Topbar -->
    <header class="topbar">
      <div class="topbar-logo">
        <div class="logo-icon" style="width:30px;height:30px;font-size:14px;border-radius:8px;">ğŸ“¡</div>
        <span class="logo-text">NEXUS</span>
      </div>
      <div class="status-bar">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">åˆæœŸåŒ–ä¸­...</span>
      </div>
      <div class="topbar-user">
        <div class="avatar" id="user-avatar">?</div>
        <span class="user-name" id="user-display"></span>
        <button class="btn-logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar">

      <div>
        <div class="sidebar-section-title">ã‚ãªãŸã®ID</div>
        <div class="my-id-box">
          <div class="my-id-label">Peer ID</div>
          <div class="my-id-val" id="my-peer-id" onclick="copyId()">ç”Ÿæˆä¸­...</div>
          <div class="copy-hint">ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼</div>
        </div>
      </div>

      <div>
        <div class="sidebar-section-title">æ¥ç¶š</div>
        <div class="connect-box">
          <input class="connect-input" id="remote-id-input" placeholder="ç›¸æ‰‹ã®Peer IDã‚’å…¥åŠ›...">
          <button class="btn-connect" onclick="connectToPeer()">æ¥ç¶šã™ã‚‹ â†’</button>
        </div>
      </div>

      <div class="peers-section">
        <div class="sidebar-section-title">æ¥ç¶šä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
        <div class="peers-list" id="peers-list">
          <div class="empty-peers">ã¾ã èª°ã‚‚æ¥ç¶šã—ã¦ã„ã¾ã›ã‚“</div>
        </div>
      </div>

    </aside>

    <!-- Main -->
    <main class="main-area">

      <div class="main-left">
        <div class="controls-bar">
          <button class="ctrl-btn" id="mic-btn" onclick="toggleMic()">
            <span class="ctrl-icon">ğŸ¤</span> ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤
          </button>
          <button class="ctrl-btn danger" id="deafen-btn" onclick="toggleDeafen()">
            <span class="ctrl-icon">ğŸ”‡</span> ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼
          </button>
          <button class="ctrl-btn" id="screen-btn" onclick="toggleScreenShare()">
            <span class="ctrl-icon">ğŸ–¥ï¸</span> ç”»é¢å…±æœ‰
          </button>
          <div class="volume-meter" id="vol-meter">
            <div class="vol-bar" style="height:3px" id="vb1"></div>
            <div class="vol-bar" style="height:3px" id="vb2"></div>
            <div class="vol-bar" style="height:3px" id="vb3"></div>
            <div class="vol-bar" style="height:3px" id="vb4"></div>
            <div class="vol-bar" style="height:3px" id="vb5"></div>
          </div>
        </div>

        <div class="mute-banner" id="mute-banner">
          ğŸ”‡ ãƒã‚¤ã‚¯ãŒãƒŸãƒ¥ãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™
        </div>

        <div class="screen-area" id="screen-area">
          <div class="screen-placeholder" id="screen-placeholder">
            <div class="ph-icon">ğŸ–¥ï¸</div>
            <h3>ç”»é¢å…±æœ‰ãªã—</h3>
            <p>ã€Œç”»é¢å…±æœ‰ã€ãƒœã‚¿ãƒ³ã§å…±æœ‰ã‚’é–‹å§‹ã™ã‚‹ã‹<br>ç›¸æ‰‹ã®å…±æœ‰ã‚’å¾…ã¡ã¾ã™</p>
          </div>
          <video id="screen-video" autoplay muted playsinline></video>
          <video id="remote-screen-video" autoplay playsinline></video>
          <div class="screen-label" id="screen-label">â— LIVE</div>
        </div>
      </div>

      <div class="messaging-panel">
        <div class="msg-header">
          <span>ãƒãƒ£ãƒƒãƒˆ</span>
          <select id="msg-peer-select" onchange="changeSelectedPeer()">
            <option value="">ã™ã¹ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</option>
          </select>
        </div>

        <div class="messages-container" id="messages-container">
          <div style="flex:1; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:0.85rem; text-align:center;">
            ã„ã¾ã®ã¨ã“ã‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“
          </div>
        </div>

        <div class="msg-input-area">
          <input type="text" id="msg-input" class="msg-text-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." onkeypress="handleMessageKeypress(event)">
          <button class="msg-btn-send" onclick="sendMessage()">é€ä¿¡</button>
          <button class="msg-btn-file" onclick="document.getElementById('file-input').click()">ğŸ“</button>
          <input type="file" id="file-input" style="display:none" onchange="handleFileSelect()">
        </div>

        <div id="upload-progress" class="upload-progress" style="display:none">
          <div class="progress-bar"><div id="progress-fill"></div></div>
          <span id="progress-text">0%</span>
        </div>
      </div>

    </main>
  </div>
</div>

<audio id="remote-audio" autoplay></audio>
<div class="notification" id="notification"></div>

<script>
// â”€â”€â”€ Storage helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DB = {
  get: (k) => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k,v) => localStorage.setItem(k, JSON.stringify(v)),
  del: (k) => localStorage.removeItem(k),
};

// â”€â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentUser = null;

function getUsers() {
  const data = DB.get('nexus_users');
  // Handle both old object format and new array format
  if (Array.isArray(data)) return data;
  if (data === null || data === undefined) return [];
  // Convert old object format to array
  return Object.keys(data);
}
function saveUsers(u) { DB.set('nexus_users', u); }

function showMsg(text, type='error') {
  document.getElementById('auth-msg').innerHTML = `<div class="msg ${type}">${text}</div>`;
}

function register() {
  const u = document.getElementById('reg-user').value.trim();
  if (!u) return showMsg('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if (!/^[a-zA-Z0-9_]+$/.test(u)) return showMsg('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã¯è‹±æ•°å­—ã¨ã‚¢ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™');
  const users = getUsers();
  if (users.includes(u)) return showMsg('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã¯æ—¢ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™');
  users.push(u);
  saveUsers(users);
  currentUser = u;
  DB.set('nexus_session', currentUser);
  try {
    startApp();
  } catch (e) {
    console.error('startApp error:', e);
    alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
}

function logout() {
  DB.del('nexus_session');
  cleanupPeer();
  document.getElementById('app-screen').style.display = 'none';
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('reg-user').value = '';
  currentUser = null;
  messages = [];
}

// â”€â”€â”€ WebRTC / PeerJS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let peer = null;
let connections = {}; // peerId -> { conn, call, screenCall }
let localStream = null;
let screenStream = null;
let isMuted = true;
let isDeafened = false;
let isScreenSharing = false;
let audioContext = null;
let analyser = null;
let volAnimId = null;

function startApp() {
  console.log('startApp called');
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app-screen').style.display = 'flex';

  document.getElementById('user-display').textContent = currentUser;
  document.getElementById('user-avatar').textContent = currentUser[0].toUpperCase();

  setStatus('connecting');
  console.log('before restoreMessagesFromStorage');
  restoreMessagesFromStorage();
  console.log('before initPeer');
  initPeer();
  console.log('startApp complete');
}

function initPeer() {
  if (peer) peer.destroy();
  // Use PeerJS default cloud server
  peer = new Peer(undefined, {
    debug: 0,
    config: {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
      ]
    }
  });

  peer.on('open', (id) => {
    document.getElementById('my-peer-id').textContent = id;
    setStatus('connected', `æ¥ç¶šæ¸ˆã¿ â€” ID: ${id.slice(0,8)}...`);
    notify('ğŸ“¡ ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ', 'success');
  });

  peer.on('connection', (conn) => {
    handleConnection(conn);
  });

  peer.on('call', (call) => {
    handleIncomingCall(call);
  });

  peer.on('error', (err) => {
    setStatus('disconnected', 'ã‚¨ãƒ©ãƒ¼: ' + err.message);
    notify('âŒ ' + err.message, 'error');
  });

  peer.on('disconnected', () => {
    setStatus('connecting', 'å†æ¥ç¶šä¸­...');
    peer.reconnect();
  });
}

function handleConnection(conn) {
  const pid = conn.peer;
  if (!connections[pid]) connections[pid] = {};
  connections[pid].conn = conn;

  conn.on('open', () => {
    conn.send({ type: 'hello', username: currentUser });
  });

  conn.on('data', (data) => {
    if (data.type === 'hello') {
      connections[pid].username = data.username;
      addPeerUI(pid, data.username);
      updatePeerSelect();
      notify(`ğŸ‘¤ ${data.username} ãŒæ¥ç¶šã—ã¾ã—ãŸ`, 'success');
    } else if (data.type === 'chat') {
      data.fromId = pid;
      receiveMessage(data);
    } else if (data.type === 'file-request') {
      // Receive file request
      data.fromId = pid;
      handleFileRequest(data);
    } else if (data.type === 'file-chunk') {
      data.fromId = pid;
      receiveFileChunk(data);
    }
  });

  conn.on('close', () => {
    removePeerUI(pid);
    delete connections[pid];
    notify(`ğŸ‘¤ åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ`, '');
  });

  conn.on('error', (e) => console.warn(e));
}

function handleIncomingCall(call) {
  const pid = call.peer;
  if (!connections[pid]) connections[pid] = {};

  if (call.metadata && call.metadata.type === 'screen') {
    call.answer();
    call.on('stream', (stream) => {
      showRemoteScreen(stream);
    });
    connections[pid].remoteScreenCall = call;
    call.on('close', () => hideRemoteScreen());
  } else {
    // Voice call
    navigator.mediaDevices.getUserMedia({ audio: true, video: false })
      .then((stream) => {
        localStream = stream;
        applyMuteState();
        call.answer(stream);
        call.on('stream', (remoteStream) => {
          playRemoteAudio(remoteStream);
        });
        connections[pid].call = call;
        setupVolumeAnalyser(stream);
      })
      .catch(() => {
        call.answer();
        call.on('stream', (remoteStream) => playRemoteAudio(remoteStream));
        connections[pid].call = call;
      });
  }

  call.on('error', (e) => console.warn(e));
}

function connectToPeer() {
  const remoteId = document.getElementById('remote-id-input').value.trim();
  if (!remoteId) return notify('Peer IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
  if (remoteId === peer.id) return notify('è‡ªåˆ†ã®IDã«ã¯æ¥ç¶šã§ãã¾ã›ã‚“', 'error');
  if (connections[remoteId]) return notify('ã™ã§ã«æ¥ç¶šä¸­ã§ã™', 'error');

  notify('ğŸ”— æ¥ç¶šä¸­...', '');

  // Data connection
  const conn = peer.connect(remoteId, { reliable: true });
  if (!connections[remoteId]) connections[remoteId] = {};
  connections[remoteId].conn = conn;

  conn.on('open', () => {
    conn.send({ type: 'hello', username: currentUser });

    // Voice call
    navigator.mediaDevices.getUserMedia({ audio: true, video: false })
      .then((stream) => {
        localStream = stream;
        applyMuteState();
        const call = peer.call(remoteId, stream);
        connections[remoteId].call = call;
        call.on('stream', (remoteStream) => {
          playRemoteAudio(remoteStream);
        });
        setupVolumeAnalyser(stream);
        notify('ğŸ¤ ãƒœã‚¤ã‚¹ãƒãƒ£ãƒƒãƒˆã«å‚åŠ ã—ã¾ã—ãŸ', 'success');
      })
      .catch(() => {
        notify('âš ï¸ ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ', 'error');
      });
  });

  conn.on('data', (data) => {
    if (data.type === 'hello') {
      connections[remoteId].username = data.username;
      addPeerUI(remoteId, data.username);
      updatePeerSelect();
      notify(`ğŸ‘¤ ${data.username} ã¨æ¥ç¶šã—ã¾ã—ãŸ`, 'success');
      document.getElementById('remote-id-input').value = '';
    } else if (data.type === 'chat') {
      data.fromId = remoteId;
      receiveMessage(data);
    } else if (data.type === 'file-request') {
      data.fromId = remoteId;
      handleFileRequest(data);
    } else if (data.type === 'file-chunk') {
      data.fromId = remoteId;
      receiveFileChunk(data);
    }
  });

  conn.on('close', () => { removePeerUI(remoteId); delete connections[remoteId]; });
  conn.on('error', (e) => notify('æ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + e, 'error'));
}

// â”€â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playRemoteAudio(stream) {
  const audio = document.getElementById('remote-audio');
  audio.srcObject = stream;
  if (isDeafened) audio.muted = true;
}

function applyMuteState() {
  if (!localStream) return;
  localStream.getAudioTracks().forEach(t => { t.enabled = !isMuted; });
  document.getElementById('mute-banner').classList.toggle('visible', isMuted);
}

function toggleMic() {
  if (!localStream) {
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then((stream) => {
        localStream = stream;
        isMuted = false;
        applyMuteState();
        updateMicBtn();
        setupVolumeAnalyser(stream);
        // Share with existing connections
        Object.keys(connections).forEach(pid => {
          if (!connections[pid].call) {
            const call = peer.call(pid, stream);
            connections[pid].call = call;
            call.on('stream', (rs) => playRemoteAudio(rs));
          }
        });
      })
      .catch(() => notify('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ', 'error'));
    return;
  }
  isMuted = !isMuted;
  applyMuteState();
  updateMicBtn();
}

function updateMicBtn() {
  const btn = document.getElementById('mic-btn');
  if (isMuted) {
    btn.classList.remove('active');
    btn.innerHTML = '<span class="ctrl-icon">ğŸ¤</span> ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤';
  } else {
    btn.classList.add('active');
    btn.innerHTML = '<span class="ctrl-icon">ğŸ™ï¸</span> ãƒŸãƒ¥ãƒ¼ãƒˆä¸­';
  }
}

function toggleDeafen() {
  isDeafened = !isDeafened;
  document.getElementById('remote-audio').muted = isDeafened;
  const btn = document.getElementById('deafen-btn');
  btn.classList.toggle('active', isDeafened);
  btn.innerHTML = isDeafened
    ? '<span class="ctrl-icon">ğŸ”•</span> ãƒŸãƒ¥ãƒ¼ãƒˆä¸­'
    : '<span class="ctrl-icon">ğŸ”‡</span> ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼';
}

function setupVolumeAnalyser(stream) {
  if (audioContext) { audioContext.close(); }
  if (volAnimId) cancelAnimationFrame(volAnimId);

  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioContext.createAnalyser();
  analyser.fftSize = 256;
  const src = audioContext.createMediaStreamSource(stream);
  src.connect(analyser);

  const bars = ['vb1','vb2','vb3','vb4','vb5'].map(id => document.getElementById(id));
  const data = new Uint8Array(analyser.frequencyBinCount);

  function draw() {
    volAnimId = requestAnimationFrame(draw);
    analyser.getByteFrequencyData(data);
    if (isMuted) { bars.forEach(b => b.style.height = '3px'); return; }
    const avg = data.slice(0, 40).reduce((a,b)=>a+b,0)/40;
    bars.forEach((b, i) => {
      const h = Math.max(3, (avg / 255) * 20 * (0.5 + Math.random() * 0.5));
      b.style.height = h + 'px';
    });
  }
  draw();
}

// â”€â”€â”€ Screen Share â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleScreenShare() {
  if (isScreenSharing) {
    stopScreenShare();
    return;
  }

  try {
    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
    isScreenSharing = true;

    const vid = document.getElementById('screen-video');
    vid.srcObject = screenStream;
    vid.style.display = 'block';
    document.getElementById('screen-placeholder').style.display = 'none';
    document.getElementById('screen-label').style.display = 'block';
    document.getElementById('screen-label').textContent = 'â— è‡ªåˆ†ã®ç”»é¢';

    document.getElementById('screen-btn').classList.add('active');
    document.getElementById('screen-btn').innerHTML = '<span class="ctrl-icon">ğŸ›‘</span> å…±æœ‰åœæ­¢';

    // Share with all connected peers
    Object.keys(connections).forEach(pid => {
      const call = peer.call(pid, screenStream, { metadata: { type: 'screen' } });
      connections[pid].screenCall = call;
    });

    screenStream.getVideoTracks()[0].addEventListener('ended', () => {
      stopScreenShare();
    });

    notify('ğŸ–¥ï¸ ç”»é¢å…±æœ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
  } catch (e) {
    if (e.name !== 'NotAllowedError') notify('ç”»é¢å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  }
}

function stopScreenShare() {
  if (screenStream) {
    screenStream.getTracks().forEach(t => t.stop());
    screenStream = null;
  }

  Object.keys(connections).forEach(pid => {
    if (connections[pid].screenCall) {
      connections[pid].screenCall.close();
      delete connections[pid].screenCall;
    }
  });

  isScreenSharing = false;
  const vid = document.getElementById('screen-video');
  vid.srcObject = null;
  vid.style.display = 'none';
  document.getElementById('screen-placeholder').style.display = 'block';
  document.getElementById('screen-label').style.display = 'none';
  document.getElementById('screen-btn').classList.remove('active');
  document.getElementById('screen-btn').innerHTML = '<span class="ctrl-icon">ğŸ–¥ï¸</span> ç”»é¢å…±æœ‰';

  // Check if remote screen is still showing
  const remVid = document.getElementById('remote-screen-video');
  if (!remVid.srcObject) {
    document.getElementById('screen-placeholder').style.display = 'block';
  }
  notify('ğŸ–¥ï¸ ç”»é¢å…±æœ‰ã‚’åœæ­¢ã—ã¾ã—ãŸ', '');
}

function showRemoteScreen(stream) {
  const vid = document.getElementById('remote-screen-video');
  vid.srcObject = stream;
  vid.style.display = 'block';
  document.getElementById('screen-video').style.display = 'none';
  document.getElementById('screen-placeholder').style.display = 'none';
  document.getElementById('screen-label').style.display = 'block';
  document.getElementById('screen-label').textContent = 'â— ç›¸æ‰‹ã®ç”»é¢';
  notify('ğŸ–¥ï¸ ç›¸æ‰‹ãŒç”»é¢å…±æœ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
}

function hideRemoteScreen() {
  const vid = document.getElementById('remote-screen-video');
  vid.srcObject = null;
  vid.style.display = 'none';
  if (!isScreenSharing) {
    document.getElementById('screen-placeholder').style.display = 'block';
    document.getElementById('screen-label').style.display = 'none';
  }
}

// â”€â”€â”€ Peer UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addPeerUI(pid, display) {
  const list = document.getElementById('peers-list');
  const existing = document.querySelector('.empty-peers');
  if (existing) existing.remove();

  const el = document.createElement('div');
  el.className = 'peer-item';
  el.id = 'peer-' + pid.replace(/[^a-z0-9]/gi,'_');
  el.innerHTML = `
    <div class="peer-dot"></div>
    <span class="peer-name" title="${pid}">${display}</span>
    <button class="btn-disconnect" onclick="disconnectPeer('${pid}')" title="åˆ‡æ–­">âœ•</button>
  `;
  list.appendChild(el);
}

function removePeerUI(pid) {
  const el = document.getElementById('peer-' + pid.replace(/[^a-z0-9]/gi,'_'));
  if (el) el.remove();
  const list = document.getElementById('peers-list');
  if (!list.children.length) {
    list.innerHTML = '<div class="empty-peers">ã¾ã èª°ã‚‚æ¥ç¶šã—ã¦ã„ã¾ã›ã‚“</div>';
  }
  updatePeerSelect();
}

function disconnectPeer(pid) {
  if (connections[pid]) {
    if (connections[pid].conn) connections[pid].conn.close();
    if (connections[pid].call) connections[pid].call.close();
    if (connections[pid].screenCall) connections[pid].screenCall.close();
    delete connections[pid];
  }
  removePeerUI(pid);
  notify('åˆ‡æ–­ã—ã¾ã—ãŸ', '');
}

function cleanupPeer() {
  if (localStream) { localStream.getTracks().forEach(t=>t.stop()); localStream = null; }
  if (screenStream) { screenStream.getTracks().forEach(t=>t.stop()); screenStream = null; }
  if (peer) { peer.destroy(); peer = null; }
  if (audioContext) { audioContext.close(); audioContext = null; }
  if (volAnimId) { cancelAnimationFrame(volAnimId); volAnimId = null; }
  connections = {};
}

// â”€â”€â”€ Messaging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let messages = [];
let currentMsgPeer = null;
let fileTransfers = {};
const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB
const CHUNK_SIZE = 100 * 1024; // 100KB

function sendMessage() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if (!text) return;

  const msg = {
    type: 'chat',
    from: currentUser,
    timestamp: Date.now(),
    text: text,
    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9)
  };

  // Send to all connected peers
  Object.keys(connections).forEach(pid => {
    if (connections[pid].conn && connections[pid].conn.open) {
      connections[pid].conn.send(msg);
    }
  });

  handleLocalMessage(msg);
  input.value = '';
  input.focus();
}

function handleLocalMessage(msg) {
  messages.push(msg);
  saveMessagesToStorage();
  addMessageToUI(msg, true);
  scrollToBottom();
}

function receiveMessage(data) {
  messages.push(data);
  saveMessagesToStorage();
  addMessageToUI(data, false);
  scrollToBottom();
  notify(`ğŸ“¨ ${data.from}: ${data.text.substring(0,30)}${data.text.length > 30 ? '...' : ''}`, 'success');
}

function addMessageToUI(msg, isSelf) {
  if (currentMsgPeer && msg.fromId !== currentMsgPeer && !isSelf) return;
  if (currentMsgPeer === '' && (!msg.fromId || !connections[msg.fromId])) return;

  const container = document.getElementById('messages-container');
  const empty = container.querySelector('div[style*="flex:1"]');
  if (empty) empty.remove();

  const msgEl = document.createElement('div');
  msgEl.className = 'message ' + (isSelf ? 'self' : 'other');

  const time = new Date(msg.timestamp).toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'});
  const content = document.createElement('div');
  content.className = 'message-content';
  content.textContent = msg.text;

  const meta = document.createElement('div');
  meta.className = 'message-meta';
  meta.textContent = `${isSelf ? 'ã‚ãªãŸ' : msg.from} â€¢ ${time}`;

  msgEl.appendChild(content);
  msgEl.appendChild(meta);
  container.appendChild(msgEl);
}

function updatePeerSelect() {
  const select = document.getElementById('msg-peer-select');
  const currentValue = select.value;

  // Remove old options except "All messages"
  while (select.children.length > 1) {
    select.removeChild(select.children[1]);
  }

  // Add peer options
  Object.keys(connections).forEach(pid => {
    const username = connections[pid].username || 'Unknown';
    const opt = document.createElement('option');
    opt.value = pid;
    opt.textContent = username;
    select.appendChild(opt);
  });
}

function changeSelectedPeer() {
  const select = document.getElementById('msg-peer-select');
  currentMsgPeer = select.value || null;
  refreshMessageContainer();
}

function refreshMessageContainer() {
  const container = document.getElementById('messages-container');
  container.innerHTML = '';

  const filteredMsgs = currentMsgPeer === null
    ? messages
    : messages.filter(m => (m.from === currentUser && m.to === currentMsgPeer) ||
                           (m.from !== currentUser && m.fromId === currentMsgPeer));

  if (filteredMsgs.length === 0) {
    container.innerHTML = '<div style="flex:1; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:0.85rem; text-align:center;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  filteredMsgs.forEach(msg => {
    const isSelf = msg.from === currentUser;
    addMessageToUI(msg, isSelf);
  });

  scrollToBottom();
}

function scrollToBottom() {
  const container = document.getElementById('messages-container');
  container.scrollTop = container.scrollHeight;
}

function handleMessageKeypress(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendMessage();
  }
}

function saveMessagesToStorage() {
  DB.set('nexus_messages', messages);
}

function restoreMessagesFromStorage() {
  messages = DB.get('nexus_messages') || [];
  refreshMessageContainer();
}

function handleFileSelect() {
  const input = document.getElementById('file-input');
  const file = input.files[0];
  if (!file) return;

  if (file.size > MAX_FILE_SIZE) {
    notify(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§100MBï¼‰`, 'error');
    input.value = '';
    return;
  }

  // If no peer selected, send to all
  const targetPeers = currentMsgPeer
    ? [currentMsgPeer]
    : Object.keys(connections).filter(pid => connections[pid].conn && connections[pid].conn.open);

  if (targetPeers.length === 0) {
    notify('âŒ æ¥ç¶šã•ã‚ŒãŸãƒ”ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
    input.value = '';
    return;
  }

  targetPeers.forEach(pid => uploadFile(pid, file));
  input.value = '';
}

function uploadFile(peerId, file) {
  const reader = new FileReader();
  const fileId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);

  reader.onload = (e) => {
    const arrayBuffer = e.target.result;
    const chunks = [];
    const totalChunks = Math.ceil(arrayBuffer.byteLength / CHUNK_SIZE);

    for (let i = 0; i < totalChunks; i++) {
      const start = i * CHUNK_SIZE;
      const end = Math.min(start + CHUNK_SIZE, arrayBuffer.byteLength);
      chunks.push(arrayBuffer.slice(start, end));
    }

    fileTransfers[fileId] = {
      fileName: file.name,
      fileSize: file.size,
      mimeType: file.mimeType,
      chunks: chunks,
      currentChunk: 0
    };

    // Send file info
    const conn = connections[peerId].conn;
    if (conn && conn.open) {
      conn.send({
        type: 'file-request',
        fileId: fileId,
        fileName: file.name,
        fileSize: file.size,
        mimeType: file.type,
        totalChunks: totalChunks,
        from: currentUser,
        fromId: peer.id
      });

      // Start sending chunks after short delay
      setTimeout(() => sendFileChunk(peerId, fileId), 100);
    }
  };

  reader.readAsArrayBuffer(file);
  notify(`ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡é–‹å§‹: ${file.name}`, '');
}

function sendFileChunk(peerId, fileId) {
  const transfer = fileTransfers[fileId];
  if (!transfer || transfer.currentChunk >= transfer.chunks.length) {
    return;
  }

  const conn = connections[peerId].conn;
  if (!conn || !conn.open) return;

  const chunk = transfer.chunks[transfer.currentChunk];
  const percent = Math.round((transfer.currentChunk / transfer.chunks.length) * 100);

  conn.send({
    type: 'file-chunk',
    fileId: fileId,
    chunkIndex: transfer.currentChunk,
    totalChunks: transfer.chunks.length,
    chunkData: chunk,
    from: currentUser
  }, { reliable: true });

  updateUploadProgress(percent);

  transfer.currentChunk++;

  if (transfer.currentChunk < transfer.chunks.length) {
    setTimeout(() => sendFileChunk(peerId, fileId), 50);
  } else {
    setTimeout(() => {
      notify(`âœ… ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡å®Œäº†: ${transfer.fileName}`, 'success');
      updateUploadProgress(0);
      document.getElementById('upload-progress').style.display = 'none';
      delete fileTransfers[fileId];
    }, 200);
  }
}

function updateUploadProgress(percent) {
  const progress = document.getElementById('upload-progress');
  if (percent > 0) {
    progress.style.display = 'flex';
    document.getElementById('progress-fill').style.width = percent + '%';
    document.getElementById('progress-text').textContent = percent + '%';
  }
}

function handleFileRequest(data) {
  const fileId = data.fileId;
  notify(`ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«å—ä¿¡é–‹å§‹: ${data.fileName} (${(data.fileSize / 1024 / 1024).toFixed(2)}MB)`, '');

  fileTransfers[fileId] = {
    fileName: data.fileName,
    fileSize: data.fileSize,
    mimeType: data.mimeType,
    totalChunks: data.totalChunks,
    chunks: [],
    received: 0,
    fromId: data.fromId,
    from: data.from
  };
}

function receiveFileChunk(data) {
  const transfer = fileTransfers[data.fileId];
  if (!transfer) {
    console.warn('Unknown file transfer:', data.fileId);
    return;
  }

  // Ensure chunks array is large enough
  while (transfer.chunks.length <= data.chunkIndex) {
    transfer.chunks.push(null);
  }

  transfer.chunks[data.chunkIndex] = data.chunkData;
  transfer.received++;

  const percent = Math.round((transfer.received / transfer.totalChunks) * 100);
  updateUploadProgress(percent);

  if (transfer.received === transfer.totalChunks) {
    // All chunks received, assemble file
    const blob = new Blob(transfer.chunks, { type: transfer.mimeType });
    downloadFile(blob, transfer.fileName);

    // Display in messages container
    const container = document.getElementById('messages-container');
    const empty = container.querySelector('div[style*="flex:1"]');
    if (empty) empty.remove();

    const msgEl = document.createElement('div');
    msgEl.className = 'message other';

    const fileEl = document.createElement('div');
    fileEl.className = 'message-file';
    fileEl.innerHTML = `
      <div class="message-file-icon">ğŸ“</div>
      <div class="message-file-info">
        <div class="message-file-name">${transfer.fileName}</div>
        <div class="message-file-size">${(transfer.fileSize / 1024 / 1024).toFixed(2)}MB</div>
      </div>
    `;
    fileEl.onclick = () => downloadFile(blob, transfer.fileName);

    const time = new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'});
    const meta = document.createElement('div');
    meta.className = 'message-meta';
    meta.textContent = `${transfer.from} â€¢ ${time}`;

    msgEl.appendChild(fileEl);
    msgEl.appendChild(meta);
    container.appendChild(msgEl);
    scrollToBottom();

    // Save to messages
    messages.push({
      type: 'file',
      from: transfer.from,
      fromId: transfer.fromId,
      timestamp: Date.now(),
      fileName: transfer.fileName,
      fileSize: transfer.fileSize,
      fileId: data.fileId,
      id: data.fileId
    });
    saveMessagesToStorage();

    notify(`âœ… ãƒ•ã‚¡ã‚¤ãƒ«å—ä¿¡å®Œäº†: ${transfer.fileName}`, 'success');
    updateUploadProgress(0);
    document.getElementById('upload-progress').style.display = 'none';
    delete fileTransfers[data.fileId];
  }
}

function downloadFile(blob, fileName) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// â”€â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(state, text) {
  const dot = document.getElementById('status-dot');
  const txt = document.getElementById('status-text');
  dot.className = 'status-dot ' + (state === 'connected' ? 'connected' : state === 'connecting' ? 'connecting' : '');
  txt.textContent = text || (state === 'connected' ? 'æ¥ç¶šæ¸ˆã¿' : state === 'connecting' ? 'æ¥ç¶šä¸­...' : 'åˆ‡æ–­');
}

let notifTimeout;
function notify(msg, type) {
  const el = document.getElementById('notification');
  el.textContent = msg;
  el.className = 'notification show ' + (type || '');
  clearTimeout(notifTimeout);
  notifTimeout = setTimeout(() => el.classList.remove('show'), 3500);
}

function copyId() {
  const id = document.getElementById('my-peer-id').textContent;
  navigator.clipboard.writeText(id).then(() => notify('ğŸ“‹ IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success'));
}

// Enter key for connect
document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && document.activeElement.id === 'remote-id-input') connectToPeer();
  if (e.key === 'Enter' && document.activeElement.id === 'reg-user') register();
});

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function init() {
  const session = DB.get('nexus_session');
  if (session) {
    currentUser = session;
    startApp();
  }
})();
</script>
</body>
</html>
